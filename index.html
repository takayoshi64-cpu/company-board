<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>株式会社寺田鉄工所 掲示板</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-color: #f3f4f6;
      --panel-bg: #ffffff;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --border: #d1d5db;
      --text-main: #111827;
      --text-sub: #6b7280;
      --header-bg: #1f2933; /* 初期ヘッダー色（設定で上書き） */
      --safety-bg: #fff9c4; /* 安全タブ選択時の背景 */
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
    }
    .page {
      max-width: 1200px;
      margin: 10px auto 24px;
      padding: 0 10px;
    }

    /* ===== ヘッダー ===== */
    header {
      background: var(--header-bg);
      color: #fff;
      border-radius: 10px;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .header-left h1 {
      margin: 0;
      font-size: 20px;
    }
    .header-left p {
      margin: 2px 0 0;
      font-size: 11px;
      opacity: 0.85;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }
    .header-date {
      margin-right: 8px;
    }
    .header-btn {
      cursor: pointer;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #111827;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .header-btn:hover {
      background: #f3f4f6;
    }

    .main-layout {
      display: grid;
      grid-template-columns: minmax(0, 2.4fr) minmax(260px, 1.2fr);
      gap: 10px;
    }
    @media (max-width: 900px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background-color: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
      margin-bottom: 8px;
    }
    .panel h2 {
      margin: 0 0 6px;
      font-size: 15px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 4px;
    }

    /* ===== タブ（部署フィルタ） ===== */
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }
    .tab-btn {
      cursor: pointer;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 12px;
      color: #374151;
    }
    .tab-btn.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    /* ===== 投稿一覧 ===== */
    .list-container {
      max-height: 420px;
      overflow-y: auto;
    }
    .item {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 0;
    }
    .item:last-child { border-bottom: none; }
    .item-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: baseline;
    }
    .item-title {
      font-weight: 600;
      font-size: 14px;
    }
    .item-meta {
      font-size: 11px;
      color: var(--text-sub);
      text-align: right;
    }
    .item-body {
      margin-top: 4px;
      font-size: 13px;
      white-space: pre-wrap;
    }
    .item-image {
      margin-top: 6px;
    }
    .item-image img {
      max-width: 100%;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }
    .badge {
      display: inline-block;
      font-size: 11px;
      padding: 1px 6px;
      border-radius: 999px;
      margin-right: 4px;
    }
    .badge-dept-management {
      background-color: #dbeafe;
      color: #1d4ed8;
    }
    .badge-dept-factory {
      background-color: #dcfce7;
      color: #15803d;
    }
    .badge-dept-news {
      background-color: #fee2e2;
      color: #b91c1c;
    }
    .badge-dept-safety {
      background-color: #fef9c3;
      color: #92400e;
    }
    .badge-important {
      border: 1px solid #b91c1c;
      color: #b91c1c;
      background-color: #fee2e2;
    }
    .item-actions {
      margin-top: 4px;
      text-align: right;
    }
    .item-actions button {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
    }
    .empty {
      font-size: 13px;
      color: var(--text-sub);
    }
    button {
      cursor: pointer;
      font-family: inherit;
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background-color: var(--accent);
      color: #ffffff;
      transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
    }
    button:hover {
      background-color: #1d4ed8;
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.35);
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    button.secondary {
      background-color: #ffffff;
      color: var(--accent);
      border-color: var(--accent);
    }
    button.danger {
      border-color: #b91c1c;
      color: #b91c1c;
      background-color: #fee2e2;
    }
    button.danger:hover {
      background-color: #fecaca;
    }

    /* ===== モーダル ===== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #ffffff;
      border-radius: 10px;
      padding: 14px 16px;
      max-width: 520px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.4);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 16px;
    }
    .modal-close {
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 18px;
      line-height: 1;
      padding: 2px 6px;
    }
    .form-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
    }
    .form-row label {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 2px;
    }
    input[type="text"],
    textarea,
    select,
    input[type="color"] {
      font-family: inherit;
      font-size: 13px;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background-color: #f9fafb;
      color: var(--text-main);
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background-color: #ffffff;
    }
    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
      justify-content: flex-end;
    }
    .image-preview {
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-sub);
    }
    .image-preview img {
      max-width: 100%;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      margin-top: 4px;
    }

    /* ===== 右側コンテンツ ===== */
    .side-panel-title {
      font-size: 15px;
      margin-bottom: 4px;
    }
    .video-frame {
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #111827;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #9ca3af;
      font-size: 13px;
      text-align: center;
      padding: 8px;
    }
    .video-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* ===== 安全掲示板カード ===== */
    .safety-extra-wrapper {
      margin-top: 8px;
    }
    .safety-extra-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }
    @media (max-width: 700px) {
      .safety-extra-grid {
        grid-template-columns: 1fr;
      }
    }
    .safety-card {
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #111827;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .safety-card-header {
      background: #111827;
      color: #ffffff;
      padding: 6px 10px;
      font-size: 13px;
      font-weight: 700;
    }
    .safety-card-body {
      padding: 8px 10px;
      font-size: 13px;
      flex: 1;
    }
    .safety-toolbar {
      display: flex;
      justify-content: flex-end;
      gap: 4px;
      margin-bottom: 4px;
      font-size: 11px;
    }
    .safety-toolbar button {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
    }
    .safety-editable {
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 6px;
      min-height: 60px;
      outline: none;
      white-space: pre-wrap;
    }
    .safety-editable:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }
    .safety-small { font-size: 12px; }
    .safety-medium { font-size: 14px; }
    .safety-large { font-size: 18px; }

    footer {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-sub);
    }
  </style>
</head>
<body>
  <div class="page">
    <header id="mainHeader">
      <div class="header-left">
        <h1>株式会社寺田鉄工所 掲示板</h1>
        <p>管理部・製造部・安全・会社ニュースなど、社内情報を一元表示します（クラウド共有版）</p>
      </div>
      <div class="header-right">
        <span id="todayText" class="header-date"></span>
        <button id="openNewPost" class="header-btn">＋ 新規投稿</button>
        <button id="openSettings" class="header-btn">⚙ 設定</button>
      </div>
    </header>

    <div id="mainLayout" class="main-layout">
      <!-- ===== 左側：掲示板 ===== -->
      <div>
        <section class="panel" id="boardPanel">
          <h2>掲示一覧</h2>
          <div class="tabs">
            <button class="tab-btn active" data-tab="all">全体</button>
            <button class="tab-btn" data-tab="management">管理部</button>
            <button class="tab-btn" data-tab="factory">製造部</button>
            <button class="tab-btn" data-tab="news">会社ニュース</button>
            <button class="tab-btn" data-tab="safety">安全掲示板</button>
          </div>
          <div id="listContainer" class="list-container"></div>

          <!-- 安全掲示板専用カード -->
          <div id="safetyExtraWrapper" class="safety-extra-wrapper" style="display:none;">
            <div class="safety-extra-grid">
              <!-- 長時間労働と健康障害防止 -->
              <div class="safety-card">
                <div class="safety-card-header">長時間労働と健康障害防止</div>
                <div class="safety-card-body">
                  <div class="safety-toolbar">
                    <button data-target="safety1" data-size="small" class="secondary">小</button>
                    <button data-target="safety1" data-size="medium" class="secondary">中</button>
                    <button data-target="safety1" data-size="large" class="secondary">大</button>
                    <button data-target="safety1" data-style="bold" class="secondary">太字</button>
                    <button data-target="safety1" data-action="save" class="secondary">保存</button>
                  </div>
                  <div id="safety1Content" class="safety-editable safety-medium" contenteditable="true">
長時間労働は心身の健康に大きな影響を与えます。
「早めの相談」「早めの休養」「早めの受診」を心がけ、
無理をせず、安全第一で働きましょう。
                  </div>
                </div>
              </div>
              <!-- 今月のワイヤー点検色 -->
              <div class="safety-card">
                <div class="safety-card-header">今月のワイヤー点検色</div>
                <div class="safety-card-body">
                  <div class="safety-toolbar">
                    <button data-target="safety2" data-size="small" class="secondary">小</button>
                    <button data-target="safety2" data-size="medium" class="secondary">中</button>
                    <button data-target="safety2" data-size="large" class="secondary">大</button>
                    <button data-target="safety2" data-style="bold" class="secondary">太字</button>
                    <button data-target="safety2" data-action="save" class="secondary">保存</button>
                  </div>
                  <div id="safety2Content" class="safety-editable safety-medium" contenteditable="true">
今月のワイヤー点検色：●●色
使用前点検・月次点検を必ず実施し、
摩耗・キンク・素線切れなど異常があれば即交換してください。
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <footer>
          ※ 掲示内容・安全掲示板カード・動画設定・ヘッダー色は Firebase に保存され、全PCで共有されます。
        </footer>
      </div>

      <!-- ===== 右側：社内コンテンツ ===== -->
      <aside>
        <section class="panel">
          <h2 class="side-panel-title">社内コンテンツ</h2>
          <div id="videoFrame" class="video-frame">
            設定画面から YouTube の共有URL を登録すると、ここに動画が表示されます。
          </div>
        </section>
      </aside>
    </div>
  </div>

  <!-- ===== 新規投稿モーダル ===== -->
  <div id="newPostModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>新しいお知らせを投稿</h2>
        <button class="modal-close" data-close="newPost">&times;</button>
      </div>
      <div class="form-row">
        <label for="titleInput">タイトル</label>
        <input id="titleInput" type="text" placeholder="例：明日の朝礼について" />
      </div>
      <div class="form-row">
        <label for="deptInput">部署</label>
        <select id="deptInput">
          <option value="management">管理部からのお知らせ</option>
          <option value="factory">製造部からのお知らせ</option>
          <option value="news">会社ニュース</option>
          <option value="safety">安全掲示板</option>
        </select>
      </div>
      <div class="form-row">
        <label for="bodyInput">本文</label>
        <textarea id="bodyInput" placeholder="掲示内容を入力してください"></textarea>
      </div>
      <div class="form-row">
        <label for="importantInput">重要度</label>
        <select id="importantInput">
          <option value="normal">通常</option>
          <option value="important">重要</option>
        </select>
      </div>
      <div class="form-row">
        <label for="authorInput">投稿者（任意）</label>
        <input id="authorInput" type="text" placeholder="例：管理部 寺田" />
      </div>
      <div class="form-row">
        <label for="imageInput">画像（任意・1枚まで）</label>
        <input id="imageInput" type="file" accept="image/*" />
        <div id="imagePreview" class="image-preview"></div>
      </div>
      <div class="button-row">
        <button class="secondary" data-close="newPost">キャンセル</button>
        <button id="submitPost">投稿する</button>
      </div>
    </div>
  </div>

  <!-- ===== 設定モーダル ===== -->
  <div id="settingsModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>掲示板の設定</h2>
        <button class="modal-close" data-close="settings">&times;</button>
      </div>
      <div class="form-row">
        <label for="headerColorInput">ヘッダーの背景色</label>
        <input id="headerColorInput" type="color" />
      </div>
      <div class="form-row">
        <label for="youtubeUrlInput">YouTube の共有URL</label>
        <input
          id="youtubeUrlInput"
          type="text"
          placeholder="例：https://www.youtube.com/watch?v=xxxxxxx"
        />
        <small style="font-size:11px;color:var(--text-sub);">
          ※ 共有ボタンからコピーしたURLを貼り付けてください。
        </small>
      </div>
      <div class="button-row">
        <button class="secondary" data-close="settings">閉じる</button>
        <button id="saveSettings">保存</button>
      </div>
    </div>
  </div>

  <!-- ===== Firebase & アプリロジック ===== -->
  <script type="module">
    // ===== Firebase SDK 読み込み =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
  getFirestore,
  collection,
  addDoc,
  query,
  orderBy,
  onSnapshot,
  serverTimestamp,
  doc,
  setDoc,
  getDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    // ===== あなたの Firebase 設定 =====
    const firebaseConfig = {
      apiKey: "AIzaSyAtY0kWxalO0B88AwpQU6bF8B4xxeFh5qc",
      authDomain: "company-board-e9c21.firebaseapp.com",
      projectId: "company-board-e9c21",
      storageBucket: "company-board-e9c21.firebasestorage.app",
      messagingSenderId: "87763888182",
      appId: "1:87763888182:web:9238e51b45c7b94b6e5097",
      measurementId: "G-NTRC5HCN0H"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ===== DOM 参照 =====
    const todayText = document.getElementById("todayText");
    const mainHeader = document.getElementById("mainHeader");
    const mainLayout = document.getElementById("mainLayout");
    const boardPanel = document.getElementById("boardPanel");
    const listContainer = document.getElementById("listContainer");
    const tabs = document.querySelectorAll(".tab-btn");
    const safetyExtraWrapper = document.getElementById("safetyExtraWrapper");

    const openNewPostBtn = document.getElementById("openNewPost");
    const openSettingsBtn = document.getElementById("openSettings");
    const newPostModalBackdrop = document.getElementById("newPostModalBackdrop");
    const settingsModalBackdrop = document.getElementById("settingsModalBackdrop");

    const titleInput = document.getElementById("titleInput");
    const deptInput = document.getElementById("deptInput");
    const bodyInput = document.getElementById("bodyInput");
    const importantInput = document.getElementById("importantInput");
    const authorInput = document.getElementById("authorInput");
    const imageInput = document.getElementById("imageInput");
    const imagePreview = document.getElementById("imagePreview");
    const submitPostBtn = document.getElementById("submitPost");

    const headerColorInput = document.getElementById("headerColorInput");
    const youtubeUrlInput = document.getElementById("youtubeUrlInput");
    const saveSettingsBtn = document.getElementById("saveSettings");
    const videoFrame = document.getElementById("videoFrame");

    const safety1Content = document.getElementById("safety1Content");
    const safety2Content = document.getElementById("safety2Content");

    // ===== 状態 =====
    let posts = [];
    let currentTab = "all";
    let currentSettings = {
      headerColor: null,
      youtubeUrl: ""
    };

    // ===== 日付表示 =====
    function updateToday() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      todayText.textContent = `本日：${y}/${m}/${day}`;
    }
    updateToday();

    // ===== タブ切り替え =====
    tabs.forEach((btn) => {
      btn.addEventListener("click", () => {
        tabs.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentTab = btn.dataset.tab;
        updateSafetyBackground();
        renderList();
      });
    });

    function updateSafetyBackground() {
      if (currentTab === "safety") {
        boardPanel.style.backgroundColor = "var(--safety-bg)";
      } else {
        boardPanel.style.backgroundColor = "var(--panel-bg)";
      }
      safetyExtraWrapper.style.display = currentTab === "safety" ? "block" : "none";
    }

    // ===== モーダル制御 =====
    function openModal(which) {
      if (which === "newPost") {
        newPostModalBackdrop.style.display = "flex";
      } else if (which === "settings") {
        settingsModalBackdrop.style.display = "flex";
      }
    }
    function closeModal(which) {
      if (which === "newPost") {
        newPostModalBackdrop.style.display = "none";
      } else if (which === "settings") {
        settingsModalBackdrop.style.display = "none";
      }
    }
    openNewPostBtn.addEventListener("click", () => openModal("newPost"));
    openSettingsBtn.addEventListener("click", () => openModal("settings"));
    document.querySelectorAll(".modal-close").forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.close;
        closeModal(target);
      });
    });
    newPostModalBackdrop.addEventListener("click", (e) => {
      if (e.target === newPostModalBackdrop) closeModal("newPost");
    });
    settingsModalBackdrop.addEventListener("click", (e) => {
      if (e.target === settingsModalBackdrop) closeModal("settings");
    });

    // ===== 画像プレビュー =====
    imageInput.addEventListener("change", () => {
      imagePreview.innerHTML = "";
      const file = imageInput.files[0];
      if (!file) return;
      const p = document.createElement("div");
      p.textContent = `選択されたファイル：${file.name}`;
      imagePreview.appendChild(p);

      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      imagePreview.appendChild(img);
    });

    // ===== 投稿処理（Firestore + Storage） =====
    submitPostBtn.addEventListener("click", async () => {
      const title = titleInput.value.trim() || "（無題）";
      const body = bodyInput.value.trim();
      const dept = deptInput.value;
      const important = importantInput.value === "important";
      const author = authorInput.value.trim();
      if (!body) {
        alert("本文を入力してください。");
        return;
      }

      submitPostBtn.disabled = true;
      submitPostBtn.textContent = "投稿中…";

      try {
        let imageUrl = "";
        const file = imageInput.files[0];
        if (file) {
          const path = `postImages/${Date.now()}_${file.name}`;
          const storageRef = ref(storage, path);
          await uploadBytes(storageRef, file);
          imageUrl = await getDownloadURL(storageRef);
        }

        await addDoc(collection(db, "posts"), {
          title,
          body,
          dept,
          important,
          author,
          imageUrl,
          createdAt: serverTimestamp()
        });

        titleInput.value = "";
        bodyInput.value = "";
        authorInput.value = "";
        importantInput.value = "normal";
        imageInput.value = "";
        imagePreview.innerHTML = "";
        closeModal("newPost");
      } catch (e) {
        console.error(e);
        alert("投稿中にエラーが発生しました。");
      } finally {
        submitPostBtn.disabled = false;
        submitPostBtn.textContent = "投稿する";
      }
    });

    // ===== Firestore から投稿一覧をリアルタイム取得 =====
    const postsQuery = query(
      collection(db, "posts"),
      orderBy("createdAt", "desc")
    );
    onSnapshot(postsQuery, (snapshot) => {
      posts = snapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data()
      }));
      renderList();
    });

    function renderList() {
      listContainer.innerHTML = "";
      const filtered = posts.filter((p) => {
        if (currentTab === "all") return true;
        return p.dept === currentTab;
      });

      if (!filtered.length) {
        const p = document.createElement("p");
        p.className = "empty";
        p.textContent = "まだ掲示はありません。新規投稿ボタンから追加してください。";
        listContainer.appendChild(p);
        return;
      }

      filtered.forEach((p) => {
        const item = document.createElement("article");
        item.className = "item";

        const header = document.createElement("div");
        header.className = "item-header";

        const left = document.createElement("div");

        const deptBadge = document.createElement("span");
        deptBadge.className = "badge " + getDeptBadgeClass(p.dept);
        deptBadge.textContent = getDeptLabel(p.dept);
        left.appendChild(deptBadge);

        if (p.important) {
          const impBadge = document.createElement("span");
          impBadge.className = "badge badge-important";
          impBadge.textContent = "重要";
          left.appendChild(impBadge);
        }

        const titleSpan = document.createElement("span");
        titleSpan.className = "item-title";
        titleSpan.textContent = p.title || "（無題）";
        left.appendChild(titleSpan);

        const meta = document.createElement("div");
        meta.className = "item-meta";
        const createdAt = p.createdAt?.toDate
          ? p.createdAt.toDate()
          : p.createdAt
          ? new Date(p.createdAt)
          : null;
        meta.innerHTML =
          (createdAt ? formatDateTime(createdAt) : "") +
          (p.author ? "<br>" + escapeHtml(p.author) : "");

        header.appendChild(left);
        header.appendChild(meta);

        const bodyDiv = document.createElement("div");
        bodyDiv.className = "item-body";
        bodyDiv.textContent = p.body || "";

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const delBtn = document.createElement("button");
        delBtn.className = "secondary danger";
        delBtn.textContent = "削除";
        delBtn.addEventListener("click", () => handleDeletePost(p.id));
        actions.appendChild(delBtn);

        item.appendChild(header);
        item.appendChild(bodyDiv);

        if (p.imageUrl) {
          const imgWrap = document.createElement("div");
          imgWrap.className = "item-image";
          const img = document.createElement("img");
          img.src = p.imageUrl;
          img.alt = "添付画像";
          imgWrap.appendChild(img);
          item.appendChild(imgWrap);
        }

        item.appendChild(actions);
        listContainer.appendChild(item);
      });
    }

 async function handleDeletePost(id) {
  if (!confirm("この掲示を削除しますか？")) return;
  try {
    await deleteDoc(doc(db, "posts", id)); // ← Firestore から完全に削除
  } catch (e) {
    console.error(e);
    alert("削除時にエラーが発生しました。");
  }
}

    function getDeptLabel(dept) {
      switch (dept) {
        case "management":
          return "管理部";
        case "factory":
          return "製造部";
        case "news":
          return "会社ニュース";
        case "safety":
          return "安全掲示板";
        default:
          return "その他";
      }
    }
    function getDeptBadgeClass(dept) {
      switch (dept) {
        case "management":
          return "badge-dept-management";
        case "factory":
          return "badge-dept-factory";
        case "news":
          return "badge-dept-news";
        case "safety":
          return "badge-dept-safety";
        default:
          return "";
      }
    }
    function formatDateTime(d) {
      if (!d || isNaN(d.getTime())) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}/${m}/${day} ${hh}:${mm}`;
    }
    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // ===== 設定（ヘッダー色・YouTube URL） =====
    const settingsDocRef = doc(db, "config", "general");

    async function loadSettings() {
      const snap = await getDoc(settingsDocRef);
      if (!snap.exists()) return;
      const data = snap.data();
      currentSettings.headerColor = data.headerColor || null;
      currentSettings.youtubeUrl = data.youtubeUrl || "";
      applySettingsToUI();
    }

    function applySettingsToUI() {
      if (currentSettings.headerColor) {
        mainHeader.style.backgroundColor = currentSettings.headerColor;
      }
      headerColorInput.value =
        currentSettings.headerColor || "#1f2933";

      youtubeUrlInput.value = currentSettings.youtubeUrl || "";
      updateVideoFrame(currentSettings.youtubeUrl || "");
    }

    function toEmbedUrl(url) {
      if (!url) return "";
      try {
        // watch?v=xxxx or youtu.be/xxxx を embed に変換
        if (url.includes("watch?v=")) {
          const u = new URL(url);
          const v = u.searchParams.get("v");
          if (v) return `https://www.youtube.com/embed/${v}`;
        }
        if (url.includes("youtu.be/")) {
          const parts = url.split("youtu.be/");
          const idPart = parts[1].split(/[?&]/)[0];
          if (idPart) return `https://www.youtube.com/embed/${idPart}`;
        }
        // それ以外はそのまま
        return url;
      } catch {
        return url;
      }
    }

    function updateVideoFrame(url) {
      videoFrame.innerHTML = "";
      if (!url) {
        videoFrame.textContent =
          "設定画面から YouTube の共有URL を登録すると、ここに動画が表示されます。";
        return;
      }
      const embed = toEmbedUrl(url);
      const iframe = document.createElement("iframe");
      iframe.src = embed;
      iframe.allow =
        "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
      iframe.allowFullscreen = true;
      videoFrame.appendChild(iframe);
    }

    saveSettingsBtn.addEventListener("click", async () => {
      const headerColor = headerColorInput.value || "#1f2933";
      const youtubeUrl = youtubeUrlInput.value.trim();

      try {
        await setDoc(
          settingsDocRef,
          { headerColor, youtubeUrl },
          { merge: true }
        );
        currentSettings.headerColor = headerColor;
        currentSettings.youtubeUrl = youtubeUrl;
        applySettingsToUI();
        alert("設定を保存しました。");
        closeModal("settings");
      } catch (e) {
        console.error(e);
        alert("設定の保存中にエラーが発生しました。");
      }
    });

    // ===== 安全掲示板カードの保存 =====
    const safetyDocRef = doc(db, "config", "safety");

    async function loadSafetyCards() {
      const snap = await getDoc(safetyDocRef);
      if (!snap.exists()) return;
      const data = snap.data();
      if (data.safety1Html) {
        safety1Content.innerHTML = data.safety1Html;
      }
      if (data.safety2Html) {
        safety2Content.innerHTML = data.safety2Html;
      }
      if (data.safety1Class) {
        safety1Content.classList.remove("safety-small","safety-medium","safety-large");
        safety1Content.classList.add(data.safety1Class);
      }
      if (data.safety2Class) {
        safety2Content.classList.remove("safety-small","safety-medium","safety-large");
        safety2Content.classList.add(data.safety2Class);
      }
      if (data.safety1Bold) {
        safety1Content.style.fontWeight = "bold";
      }
      if (data.safety2Bold) {
        safety2Content.style.fontWeight = "bold";
      }
    }

    function handleSafetyToolbarClick(e) {
      const btn = e.target.closest("button");
      if (!btn) return;
      const targetId = btn.dataset.target;
      const size = btn.dataset.size;
      const style = btn.dataset.style;
      const action = btn.dataset.action;
      const el =
        targetId === "safety1" ? safety1Content : safety2Content;

      if (!el) return;

      if (size) {
        el.classList.remove("safety-small","safety-medium","safety-large");
        if (size === "small") el.classList.add("safety-small");
        if (size === "medium") el.classList.add("safety-medium");
        if (size === "large") el.classList.add("safety-large");
      }
      if (style === "bold") {
        el.style.fontWeight = el.style.fontWeight === "bold" ? "normal" : "bold";
      }
      if (action === "save") {
        saveSafetyCards();
      }
    }

    async function saveSafetyCards() {
      try {
        const data = {
          safety1Html: safety1Content.innerHTML,
          safety2Html: safety2Content.innerHTML,
          safety1Class:
            safety1Content.classList.contains("safety-large")
              ? "safety-large"
              : safety1Content.classList.contains("safety-small")
              ? "safety-small"
              : "safety-medium",
          safety2Class:
            safety2Content.classList.contains("safety-large")
              ? "safety-large"
              : safety2Content.classList.contains("safety-small")
              ? "safety-small"
              : "safety-medium",
          safety1Bold: safety1Content.style.fontWeight === "bold",
          safety2Bold: safety2Content.style.fontWeight === "bold"
        };
        await setDoc(safetyDocRef, data, { merge: true });
        alert("安全掲示板カードを保存しました。");
      } catch (e) {
        console.error(e);
        alert("安全掲示板カード保存中にエラーが発生しました。");
      }
    }

    document
      .querySelectorAll(".safety-toolbar")
      .forEach((toolbar) => {
        toolbar.addEventListener("click", handleSafetyToolbarClick);
      });

    // ===== 初期ロード =====
    (async () => {
      await loadSettings();
      await loadSafetyCards();
      updateSafetyBackground();
    })();
  </script>
</body>
</html>
