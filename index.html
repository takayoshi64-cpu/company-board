<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>情報発信掲示板システム</title>

  <!-- Firebase（CDN / 互換レイヤー版） -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    /* ===== テーマ色 ===== */
    :root {
      --bg-color: #f3f4f6;         /* ページ背景 */
      --panel-bg: #ffffff;         /* パネル背景 */
      --accent: #2563eb;           /* メイン青 */
      --accent-soft: #dbeafe;      /* 薄い青 */
      --border: #d1d5db;           /* 枠線 */
      --text-main: #111827;        /* メイン文字色 */
      --text-sub: #6b7280;         /* サブ文字色 */
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
    }

    .page {
      max-width: 1000px;
      margin: 16px auto 32px;
      padding: 16px;
    }

    /* ===== ヘッダー ===== */
    header {
      margin-bottom: 12px;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
    }

    header p {
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--text-sub);
    }

    /* ===== タブ ===== */
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin: 8px 0 12px;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      border: none;
      background: transparent;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
      border-radius: 6px 6px 0 0;
      color: var(--text-sub);
    }

    .tab.active {
      background-color: var(--accent-soft);
      color: var(--accent);
      border: 1px solid var(--border);
      border-bottom-color: var(--bg-color);
    }

    /* ===== パネル共通 ===== */
    .panel {
      background-color: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 14px;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
      margin-bottom: 12px;
    }

    .panel h2 {
      margin: 0 0 8px;
      font-size: 16px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 4px;
    }

    /* ===== 入力フォーム ===== */
    .form-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
    }

    .form-row label {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    input[type="text"],
    textarea,
    select {
      font-family: inherit;
      font-size: 13px;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background-color: #f9fafb;
      color: var(--text-main);
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background-color: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    button {
      cursor: pointer;
      font-family: inherit;
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background-color: var(--accent);
      color: #ffffff;
      transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
    }

    button:hover {
      background-color: #1d4ed8;
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.35);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    button.secondary {
      background-color: #ffffff;
      color: var(--accent);
    }

    button.danger {
      border-color: #b91c1c;
      color: #b91c1c;
      background-color: #fee2e2;
    }

    button.danger:hover {
      background-color: #fecaca;
    }

    /* ===== 掲示一覧 ===== */
    .list-container {
      max-height: 480px;
      overflow-y: auto;
      background-color: #f9fafb;
      border-radius: 8px;
      padding: 8px;
    }

    .item {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 4px;
    }

    .item:last-child {
      border-bottom: none;
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: baseline;
    }

    .item-title {
      font-weight: 600;
      font-size: 14px;
    }

    .item-meta {
      font-size: 11px;
      color: var(--text-sub);
      text-align: right;
    }

    .item-body {
      margin-top: 4px;
      font-size: 13px;
      white-space: pre-wrap;
    }

    /* バッジ */
    .badge {
      display: inline-block;
      font-size: 11px;
      padding: 1px 6px;
      border-radius: 999px;
      margin-right: 4px;
    }

    .badge-dept-management {
      background-color: #dbeafe;
      color: #1d4ed8;
    }

    .badge-dept-factory {
      background-color: #dcfce7;
      color: #15803d;
    }

    .badge-dept-news {
      background-color: #fee2e2;
      color: #b91c1c;
    }

    .badge-dept-safety {
      background-color: #fef9c3;
      color: #92400e;
    }

    .badge-important {
      border: 1px solid #b91c1c;
      color: #b91c1c;
      background-color: #fee2e2;
    }

    .item-actions {
      margin-top: 4px;
      text-align: right;
    }

    .item-actions button {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
    }

    .empty {
      font-size: 13px;
      color: var(--text-sub);
    }

    footer {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-sub);
    }

    @media (max-width: 640px) {
      .page {
        padding: 8px;
        margin: 8px auto 16px;
      }

      header h1 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>情報発信掲示板システム</h1>
      <p>管理部・製造部・会社ニュース・安全掲示板をタブで切替（全PCで共有）</p>
    </header>

    <!-- タブ -->
    <nav class="tabs">
      <button class="tab active" data-board="all">全体情報</button>
      <button class="tab" data-board="management">管理部からのお知らせ</button>
      <button class="tab" data-board="factory">製造部からのお知らせ</button>
      <button class="tab" data-board="news">会社ニュース</button>
      <button class="tab" data-board="safety">安全掲示板</button>
    </nav>

    <!-- 入力パネル -->
    <section class="panel">
      <h2>新しいお知らせを投稿</h2>

      <div class="form-row">
        <label for="titleInput">タイトル</label>
        <input
          id="titleInput"
          type="text"
          placeholder="例：明日の朝礼について"
        />
      </div>

      <div class="form-row">
        <label for="deptInput">掲示の区分</label>
        <select id="deptInput">
          <option value="management">管理部からのお知らせ</option>
          <option value="factory">製造部からのお知らせ</option>
          <option value="news">会社ニュース</option>
          <option value="safety">安全掲示板</option>
        </select>
      </div>

      <div class="form-row">
        <label for="bodyInput">本文</label>
        <textarea
          id="bodyInput"
          placeholder="掲示内容を入力してください"
        ></textarea>
      </div>

      <div class="form-row">
        <label for="importantInput">重要度</label>
        <select id="importantInput">
          <option value="normal">通常</option>
          <option value="important">重要</option>
        </select>
      </div>

      <div class="form-row">
        <label for="authorInput">投稿者（任意）</label>
        <input id="authorInput" type="text" placeholder="例：管理部 寺田" />
      </div>

      <div class="button-row">
        <button id="addButton">投稿する</button>
      </div>
      <p class="empty" style="margin-top:4px;">
        ※ 投稿すると Firebase に保存され、全てのPCから同じ掲示が見られます。
      </p>
    </section>

    <!-- 一覧パネル -->
    <section class="panel">
      <h2>掲示一覧（タブで絞り込み）</h2>
      <div id="listContainer" class="list-container">
        <!-- JSで埋まる -->
      </div>
    </section>

    <footer>
      ※ 投稿内容は Google Firebase Firestore に保存されています。<br />
      ※ 削除は誰でも可能なサンプル仕様です（あとで管理部限定にもできます）。
    </footer>
  </div>

  <script>
    /***** Firebase 初期化（あなたのプロジェクト設定を使用） *****/
    const firebaseConfig = {
      apiKey: "AIzaSyAtY0kWxalO0B88AwpQU6bF8B4xxeFh5qc",
      authDomain: "company-board-e9c21.firebaseapp.com",
      projectId: "company-board-e9c21",
      storageBucket: "company-board-e9c21.firebasestorage.app",
      messagingSenderId: "87763888182",
      appId: "1:87763888182:web:9238e51b45c7b94b6e5097",
      measurementId: "G-NTRC5HCN0H"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const postsCol = db.collection("posts");

    /***** DOM 取得 *****/
    const titleInput = document.getElementById("titleInput");
    const deptInput = document.getElementById("deptInput");
    const bodyInput = document.getElementById("bodyInput");
    const importantInput = document.getElementById("importantInput");
    const authorInput = document.getElementById("authorInput");
    const addButton = document.getElementById("addButton");
    const listContainer = document.getElementById("listContainer");
    const tabs = document.querySelectorAll(".tab");

    let posts = [];
    let activeBoard = "all";

    /***** イベント登録 *****/
    addButton.addEventListener("click", handleAdd);

    // Ctrl+Enter(or Cmd+Enter) で投稿
    document.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        handleAdd();
      }
    });

    // タブ切り替え
    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((t) => t.classList.remove("active"));
        tab.classList.add("active");
        activeBoard = tab.getAttribute("data-board");
        renderList();
      });
    });

    /***** Firestore リアルタイム購読 *****/
    postsCol.orderBy("createdAt", "desc").onSnapshot(
      (snapshot) => {
        posts = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));
        renderList();
      },
      (err) => {
        console.error(err);
        listContainer.innerHTML =
          '<p class="empty">データの読み込みに失敗しました。Firebase設定を確認してください。</p>';
      }
    );

    /***** 投稿処理 *****/
    async function handleAdd() {
      const title = titleInput.value.trim();
      const body = bodyInput.value.trim();
      const dept = deptInput.value;
      const important = importantInput.value === "important";
      const author = authorInput.value.trim();

      if (!body) {
        alert("本文を入力してください");
        return;
      }

      try {
        await postsCol.add({
          title: title || "（無題）",
          body,
          dept,
          important,
          author,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        clearForm();
      } catch (e) {
        console.error(e);
        alert("投稿に失敗しました。Firebase の設定・ルールをご確認ください。");
      }
    }

    async function handleDelete(id) {
      if (!confirm("この掲示を削除しますか？")) return;
      try {
        await postsCol.doc(id).delete();
      } catch (e) {
        console.error(e);
        alert("削除に失敗しました。");
      }
    }

    /***** 表示レンダリング *****/
    function renderList() {
      listContainer.innerHTML = "";

      // 絞り込み
      let filtered = [];
      if (activeBoard === "all") {
        filtered = posts;
      } else {
        filtered = posts.filter((p) => p.dept === activeBoard);
      }

      if (!filtered.length) {
        const p = document.createElement("p");
        p.className = "empty";
        p.textContent = "現在、このタブに表示できる情報はありません。";
        listContainer.appendChild(p);
        return;
      }

      filtered.forEach((p) => {
        const item = document.createElement("article");
        item.className = "item";

        const header = document.createElement("div");
        header.className = "item-header";

        const left = document.createElement("div");

        // 部署バッジ
        const deptBadge = document.createElement("span");
        deptBadge.className = "badge " + getDeptBadgeClass(p.dept);
        deptBadge.textContent = getDeptLabel(p.dept);
        left.appendChild(deptBadge);

        // 重要バッジ
        if (p.important) {
          const impBadge = document.createElement("span");
          impBadge.className = "badge badge-important";
          impBadge.textContent = "重要";
          left.appendChild(impBadge);
        }

        const titleSpan = document.createElement("span");
        titleSpan.className = "item-title";
        titleSpan.textContent = p.title || "（無題）";
        left.appendChild(titleSpan);

        const meta = document.createElement("div");
        meta.className = "item-meta";
        const dateStr = formatDateTime(p.createdAt);
        meta.innerHTML =
          (dateStr ? dateStr : "") +
          (p.author ? "<br>" + escapeHtml(p.author) : "");

        header.appendChild(left);
        header.appendChild(meta);

        const bodyDiv = document.createElement("div");
        bodyDiv.className = "item-body";
        bodyDiv.textContent = p.body || "";

        const actions = document.createElement("div");
        actions.className = "item-actions";
        const delBtn = document.createElement("button");
        delBtn.className = "secondary danger";
        delBtn.textContent = "削除";
        delBtn.addEventListener("click", () => handleDelete(p.id));
        actions.appendChild(delBtn);

        item.appendChild(header);
        item.appendChild(bodyDiv);
        item.appendChild(actions);

        listContainer.appendChild(item);
      });
    }

    /***** ユーティリティ *****/
    function clearForm() {
      bodyInput.value = "";
      importantInput.value = "normal";
      bodyInput.focus();
    }

    function getDeptLabel(dept) {
      switch (dept) {
        case "management":
          return "管理部";
        case "factory":
          return "製造部";
        case "news":
          return "会社ニュース";
        case "safety":
          return "安全掲示板";
        default:
          return "その他";
      }
    }

    function getDeptBadgeClass(dept) {
      switch (dept) {
        case "management":
          return "badge-dept-management";
        case "factory":
          return "badge-dept-factory";
        case "news":
          return "badge-dept-news";
        case "safety":
          return "badge-dept-safety";
        default:
          return "";
      }
    }

    function formatDateTime(ts) {
      if (!ts) return "";
      let d;
      if (ts.toDate) {
        d = ts.toDate();
      } else {
        d = new Date(ts);
      }
      if (isNaN(d.getTime())) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}/${m}/${day} ${hh}:${mm}`;
    }

    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }
  </script>
</body>
</html>
