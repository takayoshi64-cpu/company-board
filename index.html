<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æƒ…å ±ç™ºä¿¡æ²ç¤ºæ¿ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    :root {
      --bg-color: #f3f4f6;
      --panel-bg: #ffffff;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --border: #d1d5db;
      --text-main: #111827;
      --text-sub: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      transition: background-color 0.2s ease;
    }

    /* â˜…å®‰å…¨æ²ç¤ºæ¿ã‚¿ãƒ–é¸æŠæ™‚ã ã‘ã€å…¨ä½“ã®èƒŒæ™¯è‰²ã‚’é»„è‰²ã«ã™ã‚‹â˜… */
    body.safety-mode {
      background-color: #facc15; /* ã”æŒ‡å®šã®é»„è‰² */
    }

    .page {
      max-width: 1200px;
      margin: 16px auto 32px;
      padding: 16px;
    }

    /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šå·¦ï¼æ²ç¤ºæ¿ã€å³ï¼ç¤¾å†…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .layout {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .main-column {
      flex: 2;
      min-width: 0;
    }

    .side-column {
      flex: 1;
      min-width: 260px;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    header {
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 12px;
    }

    .header-main h1 {
      margin: 0;
      font-size: 24px;
    }

    .header-main p {
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--text-sub);
    }

    .header-actions {
      white-space: nowrap;
    }

    /* ã‚¿ãƒ– */
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin: 8px 0 12px;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      border: none;
      background: transparent;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
      border-radius: 6px 6px 0 0;
      color: var(--text-sub);
    }

    .tab.active {
      background-color: var(--accent-soft);
      color: var(--accent);
      border: 1px solid var(--border);
      border-bottom-color: var(--bg-color);
    }

    /* å®‰å…¨æ²ç¤ºæ¿ã‚¿ãƒ–ã ã‘å°‘ã—å¼·èª¿ */
    .tab-safety {
      color: #92400e;
    }

    .tab-safety.active {
      background-color: #fef9c3;
      color: #92400e;
      border: 1px solid #facc15;
      border-bottom-color: var(--bg-color);
    }

    /* ãƒ‘ãƒãƒ« */
    .panel {
      background-color: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
    }

    .panel h2 {
      margin: 0 0 8px;
      font-size: 16px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 4px;
    }

    /* ãƒœã‚¿ãƒ³ */
    button {
      cursor: pointer;
      font-family: inherit;
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background-color: var(--accent);
      color: #ffffff;
      transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
    }

    button:hover {
      background-color: #1d4ed8;
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.35);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    button.secondary {
      background-color: #ffffff;
      color: var(--accent);
    }

    button.danger {
      border-color: #b91c1c;
      color: #b91c1c;
      background-color: #fee2e2;
    }

    button.danger:hover {
      background-color: #fecaca;
    }

    button.small {
      padding: 4px 8px;
      font-size: 12px;
    }

    /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
    .form-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
    }

    .form-row label {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    input[type="text"],
    textarea,
    select {
      font-family: inherit;
      font-size: 13px;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background-color: #f9fafb;
      color: var(--text-main);
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background-color: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    input[type="file"] {
      font-size: 12px;
    }

    .help-text {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    /* å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
    .image-preview-wrapper {
      margin-top: 4px;
    }

    .image-preview-label {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .image-preview {
      max-width: 240px;
      max-height: 160px;
      border-radius: 8px;
      border: 1px solid var(--border);
      object-fit: cover;
      display: block;
    }

    .hidden {
      display: none;
    }

    /* æ²ç¤ºä¸€è¦§ */
    .list-container {
      max-height: 480px;
      overflow-y: auto;
    }

    .item {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 0;
    }

    .item:last-child {
      border-bottom: none;
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: baseline;
    }

    .item-title {
      font-weight: 600;
      font-size: 14px;
    }

    .item-meta {
      font-size: 11px;
      color: var(--text-sub);
      text-align: right;
    }

    .item-body {
      margin-top: 4px;
      font-size: 13px;
      white-space: pre-wrap;
    }

    .item-image {
      margin-top: 6px;
      max-width: 100%;
      max-height: 240px;
      border-radius: 8px;
      object-fit: cover;
      display: block;
    }

    .badge {
      display: inline-block;
      font-size: 11px;
      padding: 1px 6px;
      border-radius: 999px;
      margin-right: 4px;
    }

    .badge-dept-management { background-color: #dbeafe; color: #1d4ed8; }
    .badge-dept-factory   { background-color: #dcfce7; color: #15803d; }
    .badge-dept-news      { background-color: #fee2e2; color: #b91c1c; }
    .badge-dept-safety    { background-color: #fef9c3; color: #92400e; }

    .badge-important {
      border: 1px solid #b91c1c;
      color: #b91c1c;
      background-color: #fee2e2;
    }

    .item-actions {
      margin-top: 4px;
      text-align: right;
    }

    .item-actions button {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
    }

    .empty {
      font-size: 13px;
      color: var(--text-sub);
    }

    footer {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-sub);
    }

    /* ===== å®‰å…¨æ²ç¤ºæ¿ãƒœãƒ¼ãƒ‰ï¼ˆå®‰å…¨ã‚¿ãƒ–ã®ã¨ãã ã‘è¡¨ç¤ºï¼‰ ===== */
    .safety-board-panel {
      margin-top: 4px;
    }

    .safety-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .safety-card {
      border-radius: 8px;
      overflow: hidden;
      background-color: #111827;
      color: #ffffff;
      display: flex;
      flex-direction: column;
      min-height: 140px;
    }

    .safety-card-header {
      padding: 6px 10px;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .safety-card-header span.icon {
      font-size: 14px;
      opacity: 0.8;
    }

    .safety-card-body {
      background-color: #ffffff;
      color: #111827;
      padding: 8px 10px;
      flex: 1;
    }

    .safety-card-body textarea {
      width: 100%;
      height: 100%;
      min-height: 80px;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
      font-family: inherit;
      font-size: 13px;
      padding: 4px 6px;
      resize: vertical;
    }

    .safety-card-body textarea:focus {
      outline: none;
      border-color: #f97316;
      box-shadow: 0 0 0 1px #fed7aa;
    }

    .safety-save-row {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .safety-save-row .status {
      font-size: 11px;
      color: #374151;
    }

    /* ã‚µã‚¤ãƒ‰ï¼šç¤¾å†…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .side-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .side-header h2 {
      margin: 0;
      font-size: 15px;
      border: none;
      padding-bottom: 0;
    }

    .side-section-title {
      font-size: 12px;
      color: var(--text-sub);
      margin: 0 0 6px;
    }

    .video-frame-wrapper {
      position: relative;
      width: 100%;
      padding-top: 56.25%; /* 16:9 */
      border-radius: 8px;
      overflow: hidden;
      background-color: #000;
      margin-bottom: 6px;
    }

    .video-frame-wrapper iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    .side-link {
      font-size: 12px;
      margin-top: 4px;
    }

    .side-link a {
      color: var(--accent);
      text-decoration: none;
    }

    .side-link a:hover {
      text-decoration: underline;
    }

    @media (max-width: 900px) {
      .layout {
        flex-direction: column;
      }

      .side-column {
        width: 100%;
      }
    }

    @media (max-width: 640px) {
      .page {
        padding: 8px;
        margin: 8px auto 16px;
      }

      .header-main h1 {
        font-size: 20px;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-actions {
        align-self: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="page">

    <div class="layout">
      <!-- ===== å·¦ï¼šæ²ç¤ºæ¿ ===== -->
      <div class="main-column">
        <header>
          <div class="header-main">
            <h1>æƒ…å ±ç™ºä¿¡æ²ç¤ºæ¿ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>ç®¡ç†éƒ¨ãƒ»è£½é€ éƒ¨ãƒ»ä¼šç¤¾ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ»å®‰å…¨æ²ç¤ºæ¿ã®ç¤¾å†…é€£çµ¡ã‚’ã¾ã¨ã‚ã¦è¡¨ç¤ºï¼ˆã“ã®PCä¿å­˜ç‰ˆãƒ»å†™çœŸæ·»ä»˜å¯¾å¿œï¼‰</p>
          </div>
          <div class="header-actions">
            <button id="toggleFormButton" class="secondary">ï¼‹ æ–°ã—ã„ãŠçŸ¥ã‚‰ã›ã‚’æŠ•ç¨¿</button>
          </div>
        </header>

        <!-- ã‚¿ãƒ–ï¼ˆçµã‚Šè¾¼ã¿ï¼‰ -->
        <nav class="tabs">
          <button class="tab active" data-filter="all">å…¨ä½“æƒ…å ±</button>
          <button class="tab" data-filter="management">ç®¡ç†éƒ¨</button>
          <button class="tab" data-filter="factory">è£½é€ éƒ¨</button>
          <button class="tab" data-filter="news">ä¼šç¤¾ãƒ‹ãƒ¥ãƒ¼ã‚¹</button>
          <button class="tab tab-safety" data-filter="safety">å®‰å…¨æ²ç¤ºæ¿</button>
        </nav>

        <!-- å…¥åŠ›ãƒ‘ãƒãƒ« -->
        <section id="postPanel" class="panel hidden">
          <h2>æ–°ã—ã„ãŠçŸ¥ã‚‰ã›ã‚’æŠ•ç¨¿</h2>

          <div class="form-row">
            <label for="titleInput">ã‚¿ã‚¤ãƒˆãƒ«</label>
            <input id="titleInput" type="text" placeholder="ä¾‹ï¼šæ˜æ—¥ã®æœç¤¼ã«ã¤ã„ã¦" />
          </div>

          <div class="form-row">
            <label for="deptInput">éƒ¨ç½²</label>
            <select id="deptInput">
              <option value="management">ç®¡ç†éƒ¨ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</option>
              <option value="factory">è£½é€ éƒ¨ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</option>
              <option value="news">ä¼šç¤¾ãƒ‹ãƒ¥ãƒ¼ã‚¹</option>
              <option value="safety">å®‰å…¨æ²ç¤ºæ¿</option>
            </select>
          </div>

          <div class="form-row">
            <label for="bodyInput">æœ¬æ–‡</label>
            <textarea id="bodyInput" placeholder="æ²ç¤ºå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
          </div>

          <div class="form-row">
            <label for="importantInput">é‡è¦åº¦</label>
            <select id="importantInput">
              <option value="normal">é€šå¸¸</option>
              <option value="important">é‡è¦</option>
            </select>
          </div>

          <div class="form-row">
            <label for="authorInput">æŠ•ç¨¿è€…ï¼ˆä»»æ„ï¼‰</label>
            <input id="authorInput" type="text" placeholder="ä¾‹ï¼šç®¡ç†éƒ¨ å¯ºç”°" />
          </div>

          <div class="form-row">
            <label for="imageInput">å†™çœŸã‚’æ·»ä»˜ï¼ˆä»»æ„ï¼‰</label>
            <input id="imageInput" type="file" accept="image/*" />
            <div class="help-text">
              â€» 1æšã®ã¿ã€‚500KBã€œ1MBç¨‹åº¦ã¾ã§æ¨å¥¨ï¼ˆå¤§ãã™ãã‚‹ã¨ä¿å­˜ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰ã€‚
            </div>
            <div id="imagePreviewWrapper" class="image-preview-wrapper hidden">
              <div class="image-preview-label">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
              <img id="imagePreview" class="image-preview" alt="ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" />
            </div>
          </div>

          <div class="button-row">
            <button id="addButton">æŠ•ç¨¿ã™ã‚‹</button>
            <button id="clearButton" class="danger">ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®æ²ç¤ºã‚’ã™ã¹ã¦å‰Šé™¤</button>
          </div>
        </section>

        <!-- ä¸€è¦§ãƒ‘ãƒãƒ« -->
        <section class="panel">
          <h2>æ²ç¤ºä¸€è¦§ï¼ˆã‚¿ãƒ–ã§çµã‚Šè¾¼ã¿ãƒ»æ–°ã—ã„é †ï¼‰</h2>
          <div id="listContainer" class="list-container"></div>
        </section>

        <!-- â˜…å®‰å…¨æ²ç¤ºæ¿ãƒœãƒ¼ãƒ‰ï¼šå®‰å…¨ã‚¿ãƒ–ã®ã¨ãã ã‘è¡¨ç¤ºâ˜… -->
        <section id="safetyBoardPanel" class="panel safety-board-panel hidden">
          <h2>å®‰å…¨æ²ç¤ºæ¿ãƒœãƒ¼ãƒ‰</h2>
          <p class="help-text">
            å®‰å…¨ãƒ‘ãƒˆãƒ­ãƒ¼ãƒ«ã®æŒ‡æ‘˜äº‹é …ãƒ»å®‰å…¨æˆç¸¾ãƒ»ç”£æ¥­åŒ»ã‚³ãƒ¡ãƒ³ãƒˆãªã©ã‚’ã€æœˆå˜ä½ã§ã¾ã¨ã‚ã¦æ²ç¤ºã™ã‚‹ã‚¨ãƒªã‚¢ã§ã™ï¼ˆã“ã®PCã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰ã€‚
          </p>

          <div class="safety-grid">
            <div class="safety-card">
              <div class="safety-card-header">
                <span>å®‰å…¨ãƒ‘ãƒˆãƒ­ãƒ¼ãƒ«ã®æŒ‡æ‘˜äº‹é …</span>
                <span class="icon">âœ</span>
              </div>
              <div class="safety-card-body">
                <textarea
                  class="safety-input"
                  data-key="patrolFindings"
                  placeholder="ä¾‹ï¼šãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ­ãƒ¼ãƒ—æœªç‚¹æ¤œï¼ˆBä¸­ãƒ»é–€å‹ï¼‰ã€ãƒ–ãƒªãƒƒã‚¸æœªä½¿ç”¨ ãªã©"
                ></textarea>
              </div>
            </div>

            <div class="safety-card">
              <div class="safety-card-header">
                <span>å®‰å…¨æˆç¸¾</span>
                <span class="icon">âœ</span>
              </div>
              <div class="safety-card-body">
                <textarea
                  class="safety-input"
                  data-key="safetyRecord"
                  placeholder="ä¾‹ï¼šé€£ç¶šç„¡ç½å®³è¨˜éŒ²ã¯â—‹â—‹â—‹æ—¥ã§ã™ã€€ãªã©"
                ></textarea>
              </div>
            </div>

            <div class="safety-card">
              <div class="safety-card-header">
                <span>å®‰å…¨ãƒ‘ãƒˆãƒ­ãƒ¼ãƒ«æ—¥ç¨‹</span>
                <span class="icon">âœ</span>
              </div>
              <div class="safety-card-body">
                <textarea
                  class="safety-input"
                  data-key="patrolSchedule"
                  placeholder="ä¾‹ï¼š1ç­ â—‹æœˆâ—‹æ—¥ï¼ˆé‡‘ï¼‰ã€œã€€ã¨ã„ã£ãŸæ—¥ç¨‹ã‚’è¨˜å…¥"
                ></textarea>
              </div>
            </div>

            <div class="safety-card">
              <div class="safety-card-header">
                <span>ç”£æ¥­åŒ»å·¥å ´å·¡è¦–ã‚ˆã‚Šï¼å¥åº·æƒ…å ±</span>
                <span class="icon">âœ</span>
              </div>
              <div class="safety-card-body">
                <textarea
                  class="safety-input"
                  data-key="doctorComment"
                  placeholder="ä¾‹ï¼šãƒãƒ­ã‚¦ã‚¤ãƒ«ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚¶å¯¾ç­–ã®ãŠé¡˜ã„ã€€ãªã©"
                ></textarea>
              </div>
            </div>
          </div>

          <div class="safety-save-row">
            <button id="saveSafetyBoardButton" class="secondary">å®‰å…¨ãƒœãƒ¼ãƒ‰ã‚’ä¿å­˜</button>
            <span id="safetySaveStatus" class="status"></span>
          </div>
        </section>

        <footer>
          â€» æ²ç¤ºå†…å®¹ã¨å†™çœŸãƒ»å®‰å…¨ãƒœãƒ¼ãƒ‰ã¯ã€ã“ã®PCã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br />
          â€» å†™çœŸã‚’å¤§é‡ã«ä¿å­˜ã™ã‚‹ã¨å®¹é‡åˆ¶é™ã«é”ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
        </footer>
      </div>

      <!-- ===== å³ï¼šç¤¾å†…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ¬„ ===== -->
      <aside class="side-column">
        <section class="panel">
          <div class="side-header">
            <h2>ç¤¾å†…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h2>
            <button id="toggleVideoSettings" class="secondary small">âš™ è¨­å®š</button>
          </div>
          <p class="side-section-title">
            TAKAâˆãƒãƒ£ãƒ³ãƒãƒ«ãªã©ã€ã¿ã‚“ãªã§å…±æœ‰ã—ãŸã„å‹•ç”»ã‚’å¸¸æ™‚è¡¨ç¤ºã—ã¾ã™ã€‚
          </p>

          <!-- è¡¨ç¤ºå´ -->
          <div id="videoViewArea">
            <div id="videoFrameWrapper" class="video-frame-wrapper hidden"></div>
            <p id="videoPlaceholder" class="help-text">
              ã¾ã å‹•ç”»ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å³ä¸Šã®ã€Œâš™ è¨­å®šã€ã‹ã‚‰ YouTube ã®å…±æœ‰URL
              ï¼ˆ<code>https://youtu.be/â€¦</code> ãªã©ï¼‰ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
            </p>
            <p class="side-link">
              ğŸ“º TAKAâˆ ãƒãƒ£ãƒ³ãƒãƒ«ï¼š
              <a href="https://www.youtube.com/channel/UCydsY3SpEFZ8pEdkTrntNwQ" target="_blank" rel="noopener">
                YouTubeã§é–‹ã
              </a>
            </p>
          </div>

          <!-- è¨­å®šãƒ•ã‚©ãƒ¼ãƒ  -->
          <div id="videoSettingsArea" class="hidden">
            <div class="form-row">
              <label for="videoUrlInput">YouTube ã®å…±æœ‰URL</label>
              <input
                id="videoUrlInput"
                type="text"
                placeholder="ä¾‹ï¼š https://youtu.be/XXXXXXXXXXX"
              />
              <div class="help-text">
                ãƒ»<code>https://youtu.be/â€¦</code> ã¾ãŸã¯
                <code>https://www.youtube.com/watch?v=â€¦</code> ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br />
                ãƒ»ãƒãƒ£ãƒ³ãƒãƒ«URLã¯åŸ‹ã‚è¾¼ã¿ã§ããªã„ã®ã§ã€ã€ŒãŠã™ã™ã‚å‹•ç”»ã€ã®URLã‚’1æœ¬æ±ºã‚ã¦ç™»éŒ²ã™ã‚‹æƒ³å®šã§ã™ã€‚
              </div>
            </div>
            <div class="button-row">
              <button id="saveVideoUrlButton">ä¿å­˜</button>
              <button id="cancelVideoUrlButton" class="secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          </div>
        </section>
      </aside>
    </div>
  </div>

  <script>
    // ===== æ²ç¤ºæ¿ç”¨è¨­å®š =====
    const STORAGE_KEY = "public_display_board_v1";
    const VIDEO_STORAGE_KEY = "company_board_video_url";
    const SAFETY_BOARD_KEY = "safety_board_v1";

    // DOMå‚ç…§ï¼ˆæ²ç¤ºæ¿ï¼‰
    const titleInput = document.getElementById("titleInput");
    const deptInput = document.getElementById("deptInput");
    const bodyInput = document.getElementById("bodyInput");
    const importantInput = document.getElementById("importantInput");
    const authorInput = document.getElementById("authorInput");
    const imageInput = document.getElementById("imageInput");
    const imagePreviewWrapper = document.getElementById("imagePreviewWrapper");
    const imagePreview = document.getElementById("imagePreview");

    const addButton = document.getElementById("addButton");
    const clearButton = document.getElementById("clearButton");
    const listContainer = document.getElementById("listContainer");
    const tabs = document.querySelectorAll(".tab");
    const postPanel = document.getElementById("postPanel");
    const toggleFormButton = document.getElementById("toggleFormButton");

    // å®‰å…¨ãƒœãƒ¼ãƒ‰
    const safetyBoardPanel = document.getElementById("safetyBoardPanel");
    const safetyInputs = document.querySelectorAll(".safety-input");
    const saveSafetyBoardButton = document.getElementById("saveSafetyBoardButton");
    const safetySaveStatus = document.getElementById("safetySaveStatus");

    // DOMå‚ç…§ï¼ˆç¤¾å†…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼‰
    const toggleVideoSettingsButton = document.getElementById("toggleVideoSettings");
    const videoViewArea = document.getElementById("videoViewArea");
    const videoSettingsArea = document.getElementById("videoSettingsArea");
    const videoFrameWrapper = document.getElementById("videoFrameWrapper");
    const videoPlaceholder = document.getElementById("videoPlaceholder");
    const videoUrlInput = document.getElementById("videoUrlInput");
    const saveVideoUrlButton = document.getElementById("saveVideoUrlButton");
    const cancelVideoUrlButton = document.getElementById("cancelVideoUrlButton");

    // ãƒ‡ãƒ¼ã‚¿
    let posts = loadPosts();
    let activeFilter = "all";
    let currentImageDataUrl = null;
    let formOpen = false;

    // å‹•ç”»URL
    let currentVideoUrl = loadVideoUrl();
    renderVideoArea(currentVideoUrl);

    // å®‰å…¨ãƒœãƒ¼ãƒ‰åˆæœŸå€¤
    let safetyBoard = loadSafetyBoard();
    applySafetyBoardToInputs();

    // åˆæœŸæç”»
    renderList();

    // ===== æ²ç¤ºæ¿ã‚¤ãƒ™ãƒ³ãƒˆ =====
    addButton.addEventListener("click", handleAdd);
    clearButton.addEventListener("click", handleClearAll);
    imageInput.addEventListener("change", handleImageChange);

    toggleFormButton.addEventListener("click", () => {
      formOpen = !formOpen;
      if (formOpen) {
        postPanel.classList.remove("hidden");
        toggleFormButton.textContent = "æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹";
        postPanel.scrollIntoView({ behavior: "smooth", block: "start" });
      } else {
        postPanel.classList.add("hidden");
        toggleFormButton.textContent = "ï¼‹ æ–°ã—ã„ãŠçŸ¥ã‚‰ã›ã‚’æŠ•ç¨¿";
      }
    });

    document.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        if (!formOpen) return;
        handleAdd();
      }
    });

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((t) => t.classList.remove("active"));
        tab.classList.add("active");
        activeFilter = tab.dataset.filter;
        renderList();
      });
    });

    // å®‰å…¨ãƒœãƒ¼ãƒ‰ä¿å­˜
    saveSafetyBoardButton.addEventListener("click", () => {
      safetyBoard = {};
      safetyInputs.forEach((input) => {
        const key = input.dataset.key;
        safetyBoard[key] = input.value;
      });
      saveSafetyBoard(safetyBoard);
      safetySaveStatus.textContent = "ä¿å­˜ã—ã¾ã—ãŸã€‚";
      setTimeout(() => {
        safetySaveStatus.textContent = "";
      }, 2000);
    });

    // ===== ç¤¾å†…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¤ãƒ™ãƒ³ãƒˆ =====
    toggleVideoSettingsButton.addEventListener("click", () => {
      const isOpen = !videoSettingsArea.classList.contains("hidden");
      if (isOpen) {
        videoSettingsArea.classList.add("hidden");
        videoViewArea.classList.remove("hidden");
      } else {
        videoUrlInput.value = currentVideoUrl || "";
        videoSettingsArea.classList.remove("hidden");
        videoViewArea.classList.add("hidden");
        videoUrlInput.focus();
      }
    });

    saveVideoUrlButton.addEventListener("click", () => {
      const url = videoUrlInput.value.trim();
      if (!url) {
        currentVideoUrl = "";
        saveVideoUrl("");
        renderVideoArea("");
      } else {
        currentVideoUrl = url;
        saveVideoUrl(url);
        renderVideoArea(url);
      }
      videoSettingsArea.classList.add("hidden");
      videoViewArea.classList.remove("hidden");
    });

    cancelVideoUrlButton.addEventListener("click", () => {
      videoSettingsArea.classList.add("hidden");
      videoViewArea.classList.remove("hidden");
    });

    // ===== ç”»åƒé¸æŠå‡¦ç† =====
    function handleImageChange(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) {
        currentImageDataUrl = null;
        hideImagePreview();
        return;
      }

      const limitBytes = 1 * 1024 * 1024; // 1MB
      if (file.size > limitBytes) {
        alert("ç”»åƒãŒå¤§ãã™ãã¾ã™ã€‚1MBä»¥ä¸‹ã®ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
        imageInput.value = "";
        currentImageDataUrl = null;
        hideImagePreview();
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        currentImageDataUrl = reader.result;
        showImagePreview(currentImageDataUrl);
      };
      reader.onerror = () => {
        console.error(reader.error);
        alert("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚");
        imageInput.value = "";
        currentImageDataUrl = null;
        hideImagePreview();
      };
      reader.readAsDataURL(file);
    }

    function showImagePreview(dataUrl) {
      if (!dataUrl) return;
      imagePreview.src = dataUrl;
      imagePreviewWrapper.classList.remove("hidden");
    }

    function hideImagePreview() {
      imagePreview.src = "";
      imagePreviewWrapper.classList.add("hidden");
    }

    // ===== æ²ç¤ºå‡¦ç† =====
    function handleAdd() {
      const title = titleInput.value.trim();
      const body = bodyInput.value.trim();
      const dept = deptInput.value;
      const important = importantInput.value;
      const author = authorInput.value.trim();

      if (!body) {
        alert("æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      const now = new Date();
      const post = {
        id: Date.now(),
        title: title || "ï¼ˆç„¡é¡Œï¼‰",
        body,
        dept,
        important: important === "important",
        author,
        createdAt: now.toISOString(),
        imageDataUrl: currentImageDataUrl || null,
      };

      posts.unshift(post);
      try {
        savePosts(posts);
      } catch (e) {
        console.error(e);
        alert("ä¿å­˜å®¹é‡ã‚’è¶…ãˆã¾ã—ãŸã€‚å¤ã„æ²ç¤ºã‚„ç”»åƒã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚");
      }
      renderList();
      clearForm();
    }

    function handleClearAll() {
      if (!confirm("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹æ²ç¤ºã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        return;
      }
      posts = [];
      savePosts(posts);
      renderList();
    }

    function handleDelete(id) {
      if (!confirm("ã“ã®æ²ç¤ºã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      posts = posts.filter((p) => p.id !== id);
      savePosts(posts);
      renderList();
    }

    function loadPosts() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    function savePosts(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function renderList() {
      // èƒŒæ™¯è‰²ï¼†å®‰å…¨ãƒœãƒ¼ãƒ‰ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      updateSafetyBackground();
      updateSafetyBoardVisibility();

      listContainer.innerHTML = "";

      let target = posts;
      if (activeFilter !== "all") {
        target = posts.filter((p) => p.dept === activeFilter);
      }

      if (!target.length) {
        const p = document.createElement("p");
        p.className = "empty";
        p.textContent = "ã“ã®ã‚¿ãƒ–ã«è©²å½“ã™ã‚‹æ²ç¤ºã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
        listContainer.appendChild(p);
        return;
      }

      target.forEach((p) => {
        const item = document.createElement("article");
        item.className = "item";

        const header = document.createElement("div");
        header.className = "item-header";

        const left = document.createElement("div");

        const deptBadge = document.createElement("span");
        deptBadge.className = "badge " + getDeptBadgeClass(p.dept);
        deptBadge.textContent = getDeptLabel(p.dept);
        left.appendChild(deptBadge);

        if (p.important) {
          const impBadge = document.createElement("span");
          impBadge.className = "badge badge-important";
          impBadge.textContent = "é‡è¦";
          left.appendChild(impBadge);
        }

        const titleSpan = document.createElement("span");
        titleSpan.className = "item-title";
        titleSpan.textContent = p.title;
        left.appendChild(titleSpan);

        const meta = document.createElement("div");
        meta.className = "item-meta";
        meta.innerHTML =
          formatDateTime(p.createdAt) +
          (p.author ? "<br>" + escapeHtml(p.author) : "");

        header.appendChild(left);
        header.appendChild(meta);

        const bodyDiv = document.createElement("div");
        bodyDiv.className = "item-body";
        bodyDiv.textContent = p.body;

        if (p.imageDataUrl) {
          const img = document.createElement("img");
          img.className = "item-image";
          img.src = p.imageDataUrl;
          img.alt = "æ·»ä»˜ç”»åƒ";
          bodyDiv.appendChild(img);
        }

        const actions = document.createElement("div");
        actions.className = "item-actions";
        const delBtn = document.createElement("button");
        delBtn.className = "secondary danger";
        delBtn.textContent = "å‰Šé™¤";
        delBtn.addEventListener("click", () => handleDelete(p.id));
        actions.appendChild(delBtn);

        item.appendChild(header);
        item.appendChild(bodyDiv);
        item.appendChild(actions);

        listContainer.appendChild(item);
      });
    }

    function clearForm() {
      bodyInput.value = "";
      importantInput.value = "normal";
      imageInput.value = "";
      currentImageDataUrl = null;
      hideImagePreview();
      bodyInput.focus();
    }

    function getDeptLabel(dept) {
      switch (dept) {
        case "management":
          return "ç®¡ç†éƒ¨";
        case "factory":
          return "è£½é€ éƒ¨";
        case "news":
          return "ä¼šç¤¾ãƒ‹ãƒ¥ãƒ¼ã‚¹";
        case "safety":
          return "å®‰å…¨æ²ç¤ºæ¿";
        default:
          return "ãã®ä»–";
      }
    }

    function getDeptBadgeClass(dept) {
      switch (dept) {
        case "management":
          return "badge-dept-management";
        case "factory":
          return "badge-dept-factory";
        case "news":
          return "badge-dept-news";
        case "safety":
          return "badge-dept-safety";
        default:
          return "";
      }
    }

    function formatDateTime(iso) {
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}/${m}/${day} ${hh}:${mm}`;
    }

    // å®‰å…¨ã‚¿ãƒ–ã®ã¨ãèƒŒæ™¯è‰² ON/OFF
    function updateSafetyBackground() {
      if (activeFilter === "safety") {
        document.body.classList.add("safety-mode");
      } else {
        document.body.classList.remove("safety-mode");
      }
    }

    // å®‰å…¨ãƒœãƒ¼ãƒ‰ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    function updateSafetyBoardVisibility() {
      if (activeFilter === "safety") {
        safetyBoardPanel.classList.remove("hidden");
      } else {
        safetyBoardPanel.classList.add("hidden");
      }
    }

    // ===== ç¤¾å†…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼šå‹•ç”»URLä¿å­˜ãƒ»è¡¨ç¤º =====
    function loadVideoUrl() {
      try {
        return localStorage.getItem(VIDEO_STORAGE_KEY) || "";
      } catch (e) {
        console.error(e);
        return "";
      }
    }

    function saveVideoUrl(url) {
      try {
        localStorage.setItem(VIDEO_STORAGE_KEY, url || "");
      } catch (e) {
        console.error(e);
      }
    }

    function renderVideoArea(url) {
      videoFrameWrapper.innerHTML = "";

      if (!url) {
        videoFrameWrapper.classList.add("hidden");
        videoPlaceholder.classList.remove("hidden");
        return;
      }

      const embedUrl = toYouTubeEmbedUrl(url);
      if (embedUrl) {
        const id = getYouTubeId(url);
        const iframe = document.createElement("iframe");
        iframe.src =
          embedUrl + "?autoplay=1&mute=1&loop=1" + (id ? "&playlist=" + id : "");
        iframe.allow =
          "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
        iframe.allowFullscreen = true;
        videoFrameWrapper.appendChild(iframe);
        videoFrameWrapper.classList.remove("hidden");
        videoPlaceholder.classList.add("hidden");
      } else {
        videoFrameWrapper.classList.add("hidden");
        videoPlaceholder.classList.remove("hidden");
      }
    }

    function getYouTubeId(url) {
      try {
        const u = new URL(url);
        if (u.hostname === "youtu.be") {
          return u.pathname.replace("/", "");
        }
        if (u.hostname.includes("youtube.com")) {
          return u.searchParams.get("v");
        }
        return "";
      } catch (e) {
        return "";
      }
    }

    function toYouTubeEmbedUrl(url) {
      const id = getYouTubeId(url);
      if (!id) return "";
      return "https://www.youtube.com/embed/" + id;
    }

    // ===== å®‰å…¨ãƒœãƒ¼ãƒ‰ä¿å­˜ï¼èª­ã¿è¾¼ã¿ =====
    function loadSafetyBoard() {
      try {
        const raw = localStorage.getItem(SAFETY_BOARD_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch (e) {
        console.error(e);
        return {};
      }
    }

    function saveSafetyBoard(data) {
      try {
        localStorage.setItem(SAFETY_BOARD_KEY, JSON.stringify(data));
      } catch (e) {
        console.error(e);
      }
    }

    function applySafetyBoardToInputs() {
      safetyInputs.forEach((input) => {
        const key = input.dataset.key;
        if (key && safetyBoard[key]) {
          input.value = safetyBoard[key];
        }
      });
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }
  </script>
</body>
</html>
